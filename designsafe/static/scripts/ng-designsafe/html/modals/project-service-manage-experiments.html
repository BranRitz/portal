<div class="modal-header">
    <h3 class="modal-title">
        {{ data.project.value.title }}<br>
        <small>Manage Experiments</small>
    </h3>
</div>
<div class="modal-body">
    <div ng-if="data.busy">
        <p class="lead">
            <i class="fa fa-spinner fa-spin"></i>
            Loading experiments data...
        </p>
    </div>
    <div ng-if="! data.busy && data.error">
        <p class="alert alert-danger lead">
            {{ data.error }}
        </p>
    </div>
    <div ng-if="! (data.busy || data.error)" class='experiments-listing'>
        <div class='existing-experiments-listing'>
          <table class="table">
            <thead>
              <tr>
                <th>Experiment Title</th>
                <th>Experimental Facility</th>
                <th>Experiment Equipment</th>
                <th style="width:15px;"></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat-start="experiment in data.experiments"
                  ng-class="{'experiment-deleted': ui.experiments[experiment.uuid].deleted}">
                <td>{{experiment.value.title}}</td>
                <td>{{getEF(experiment.value.experimentalFacility).label}}</td>
                <td>{{getET(getEF(experiment.value.experimentalFacility).name, experiment.value.experimentType).label}}</td>
                <td><button class="btn btn-sm btn-danger"
                            ng-click="toggleDeleteExperiment(experiment.uuid)">
                    <i class="fa" ng-class="{'fa-mail-reply': ui.experiments[experiment.uuid].deleted, 'fa-remove': !ui.experiments[experiment.uuid].deleted}"></i>
                    <span class="sr-only">Delete</span>
              </tr>
              <tr ng-repeat-end style="border-bottom:2px solid black;"
                  ng-class="{'experiment-deleted': ui.experiments[experiment.uuid].deleted}">
                <td colspan="3">{{experiment.value.description}}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <form>
            <div class="well well-sm">
                <p>Add Experiment(s):</p>
                <!--<div class="form-group" ng-repeat="add in form.addCoPis">-->
                <div class="form-group">
                    <div class="row">
                        <div class="col-xs-8" style="width:100%;">
                        <table class="table">
                          <thead>
                            <tr>
                            <td>Experiment Title</td>
                            <td>Experiment Facility</td>
                            <td>Experiment Type</td>
                            </tr>
                          </thead>
                          <tbody>
                            <tr ng-repeat-start="exp in form.addExperiments">
                              <td>
                              <input type="text" class="form-control" id="id_experiment_title"
                                     ng-model="exp.title">
                              </td>
                              <td>
                          <select ng-options="ef.name as ef.label for ef in ui.efs[data.project.value.projectType]"
                                  class="form-control"
                                  ng-model="exp.experimentalFacility"
                                  id="experiment-ef">
                          </select>
                              </td>
                              <td>
                          <select ng-options="et.name as et.label for et in ui.experimentTypes[exp.experimentalFacility]"
                                 class="form-control"
                                 ng-model="exp.experimentType"
                                 id="id_experiment_type">
                          </select>
                              </td>
                            </tr>
                            <tr>
                              <td colspan="3">
                                <textarea style="width:100%; height:3em;" 
                                          id="id_experiment_description"
                                          placeholder="Descrpition..."
                                          ng-model="exp.description"></textarea>
                              </td>
                            </tr>
                            <tr ng-if="$index > 0" ng-repeat-end>
                              <td colspan="3">
                                <button class="btn btn-danger btn-sm"
                                        ng-click="delNewExperiment($index)">
                                          <i class="fa fa-remove"></i>
                                          <span class="sr-only">Remove</span>
                                </button>
                            </tr>
                          </tbody>
                        </table>    
                        </div>
                    </div>
                </div>
                <button class="btn btn-info btn-sm" ng-click="addExperiment()">
                    <i class="fa fa-plus"></i> Add Another Experiment
                </button>
            </div>
        </form>
        <button ng-disabled="data.busy || data.error" class="btn btn-primary"
                type="button" ng-click="saveExperiments($event)">
            Save
        </button>
    </div>
    <div class="data-model-tree">
      <ul class="experiments-ul">
        <li class="tree-container"
            ng-repeat="experiment in data.project.experiment_set | orderBy: experiment.value.title"
            style="border:none;">
          <div class="tree-el">  
          <span class="ul-title">{{experiment.value.title}}</span>
          </div>
          <ul class="model-config-ul">
            <li class="tree-container"
                ng-repeat="modelConfig in data.project.getRelated('modelconfiguration_set', experiment.uuid)">
              <div class="tree-el">
              <span class="label tag-blue">Model Config</span>
              <span class="tag-title">{{modelConfig.value.title}}</span>
              <button class="btn btn-xsm btn-danger"
                      ng-if="data.project.getRelated('sensorlist_set', [experiment.uuid, modelConfig.uuid] ).length === 0"
                      ng-click="delRelEntity(modelConfig,{experiments: experiment.uuid})">
                <i class="fa fa-minus"></i>
                <span class="sr-only">Delete</span>
              </button>
              </div>
              <ul class="sensor-list-ul">
                <li class="tree-container"
                    ng-repeat="sensorList in data.project.getRelated('sensorlist_set', [experiment.uuid, modelConfig.uuid])">
                  <div class="tree-el">  
                  <span class="label tag-green">Sensor</span>
                  <span class="tag-title">{{sensorList.value.title}}</span>
                  <button class="btn btn-xsm btn-danger"
                          ng-if="data.project.getRelated('event_set', [experiment.uuid, modelConfig.uuid, sensorList.uuid]).length === 0"
                          ng-click="delRelEntity(modelConfig, {experiments: experiment.uuid,
                                                               modelConfigs: modelConfig.uuid})">
                    <i class="fa fa-minus"></i>
                    <span class="sr-only">Delete</span>
                  </button>
                  </div>
                  <ul>
                    <li 
                        ng-repeat="event in data.project.getRelated('event_set', [experiment.uuid, modelConfig.uuid, sensorList.uuid])">
                      <div class="tree-el">
                      <span class="label tag-red tree-el">Event</span>
                      <span class="tag-title">{{event.value.title}}</span>
                      <button class="btn btn-xsm btn-danger"
                              ng-if="data.project.getRelated('event_set', [experiment.uuid, modelConfig.uuid, sensorList.uuid, event.uuid]).length === 0"
                              ng-click="delRelEntity(sensorList, {experiments: experiment.uuid,
                                                                  modelConfigs: modelConfig.uuid,
                                                                  sensorLists: sensorList.uuid})">
                        <i class="fa fa-minus"></i>
                        <span class="sr-only">Delete</span>
                      </button>
                      </div>
                    </li>
                    <!--
                    <li ng-if="data.project.getRelated('event_set', [experiment.uuid, modelConfig.uuid, sensorList.uuid]).length => 0">
                    -->
                    <li>
                      <div class="tree-el">
                      <select
                              ng-options="entity as entity.value.title for entity in data.project.event_set"
                              ng-model="form.updateExperiments[experiment.uuid][modelConfig.uuid][sensorList.uuid].relEvent">
                      </select>
                      <button class="btn btn-sm btn-info"
                              ng-click="saveRelEntity(form.updateExperiments[experiment.uuid][modelConfig.uuid][sensorList.uuid].relEvent,
                                                  {project:data.project.uuid,
                                                   experiments: experiment.uuid,
                                                   modelConfigs:modelConfig.uuid,
                                                   sensorLists: sensorList.uuid})">
                        <i class="fa fa-plus"></i><span class="sr-only">Add Event</span>
                      </button>
                      </div>
                    </li>
                  </ul>
                </li>
                <!--
                <li ng-if="data.project.getRelated('sensorlist_set', [experiment.uuid, modelConfig.uuid]).length === 0">
                -->
                <li>
                  <div class="tree-el">
                  <select
                          ng-options="entity as entity.value.title for entity in data.project.sensorlist_set"
                          ng-model="form.updateExperiments[experiment.uuid][modelConfig.uuid].relSensorList">
                  </select>
                  <button class="btn btn-sm btn-info"
                          ng-click="saveRelEntity(form.updateExperiments[experiment.uuid][modelConfig.uuid].relSensorList,
                                              {project:data.project.uuid,
                                               experiments: experiment.uuid,
                                               modelConfigs: modelConfig.uuid})">
                    <i class="fa fa-plus"></i><span class="sr-only">Add Sensor</span>
                  </button>
                  </div>
                </li>
              </ul>
            </li>
            <li>
              <div class="tree-el">
              <select 
                      ng-options="entity as entity.value.title for entity in data.project.modelconfiguration_set"
                      ng-model="form.updateExperiments[experiment.uuid].relModelConfig">
              </select>
              <button class="btn btn-sm btn-info"
                      ng-click="saveRelEntity(form.updateExperiments[experiment.uuid].relModelConfig,
                                          {project:data.project.uuid,
                                           experiments:experiment.uuid})">
                <i class="fa fa-plus"></i><span class="sr-only">Add Model Config</span>
              </button>
              </div>
            </li>
          </ul>
        </li>
      </ul>
    </div>
</div>
<div class="modal-footer">
    <div class="text-right">
        <button class="btn btn-default" type="button" ng-click="cancel()">Close</button>
        <!--
        <button ng-disabled="data.busy || data.error" class="btn btn-primary"
                type="button" ng-click="saveExperiments($event)">
            Save
        </button>
        -->
    </div>
</div>
